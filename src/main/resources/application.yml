spring:
  application:
    name: server


  jpa:
    hibernate:
      ddl-auto: ${SPRING_JPA_HIBERNATE_DDL_AUTO:none}
    show-sql: ${SPRING_JPA_SHOW_SQL:false}
    properties:
      hibernate:
        format_sql: true
        dialect: org.hibernate.dialect.MariaDBDialect

  servlet:
    multipart:
      enabled: true
      max-file-size: 100MB
      max-request-size: 100MB    
  ai:
    openai:
      api-key: ${OPENAI_API_KEY}
      base-url: https://api.groq.com/openai
      chat:
        options:
          model: meta-llama/llama-4-scout-17b-16e-instruct
          temperature: 0.7
          max-tokens: 2000
  open-data:
      address-api-key: ${ADDRESS_API_KEY}
      address-url: ${ADDRESS_URL}
      SGIS-key: ${SGIS_KEY}
      SGIS-secret: ${SGIS_SECRET}
      SGIS-token-url: ${SGIS_TOKEN_URL}
      SGIS-code-url: ${SGIS_CODE_URL}
      BL-expos-url: ${BL_EXPOSE_URL}
      BL-title-url: ${BL_TITLE_URL}
      open-data-key: ${OPEN_DATA_KEY}
      vworld-url: ${VWORLD_URL}
      vworld-key: ${VWORLD_KEY}


  docker:
    compose:
      enabled: false

prompts:
  deep-prompt: |
    아래는 전세 매물 입력값과 등기부 파싱 결과(선택)야. 이를 근거로 OpenAPI 1.2.0의 AnalysisReport 스키마와 동일한 JSON을 생성해.
        
        [오늘의 날짜]
        - date: {{localDateTime}}
    
        [요청 입력]
        - address: {{address}}            # 사용자가 입력한 주소(문자열)
        - leaseDeposit: {{leaseDeposit}}  # 전세 보증금(원, 정수)
        - landlord: {{landlord}}          # 임대인 이름(선택, 없으면 빈 문자열)

        [유저의 실거래가 및 시스템 추정 시세]
        - userMarketPrice: {{userMarketPrice}}
        - marketPrice: {{marketPrice}}

        [건축물대장 분석 결과]
        - result: {{buildingLedgerResult}}

        [등기부 파싱 결과 ParseResultDto] 
        - address: {{parseResultDto.address}}
        - uniqueNumber: {{parseResultDto.uniqueNumber}}

        - coverSection.mainBuildingInfo:
          · address: {{parseResultDto.coverSection.mainBuildingInfo.address}}
          · buildingName: {{parseResultDto.coverSection.mainBuildingInfo.buildingName}}
          · structure: {{parseResultDto.coverSection.mainBuildingInfo.structure}}
          · totalFloors: {{parseResultDto.coverSection.mainBuildingInfo.totalFloors}}

        - coverSection.propertyInfo:
          · floorAndUnit: {{parseResultDto.coverSection.propertyInfo.floorAndUnit}}
          · structure: {{parseResultDto.coverSection.propertyInfo.structure}}
          · area: {{parseResultDto.coverSection.propertyInfo.area}}
        
        - coverSection.landRights[]:
        {{#parseResultDto.coverSection.landRights}}
        · { type: "{{type}}", ratio: "{{ratio}}" }
        {{/parseResultDto.coverSection.landRights}}

        - gapguSection.ownershipHistory[]:
        {{#parseResultDto.gapguSection.ownershipHistory}}
        · { sequence: {{sequence}}, receiptDate: "{{receiptDate}}", cause: "{{cause}}", ownerName: "{{ownerName}}", dealPrice: {{dealPrice}} }
        {{/parseResultDto.gapguSection.ownershipHistory}}

        - eulguSection.lienHistory[]:
        {{#parseResultDto.eulguSection.lienHistory}}
        · { sequence: {{sequence}}, type: "{{type}}", receiptDate: "{{receiptDate}}", cause: "{{cause}}", debtor: "{{debtor}}", creditor: "{{creditor}}", amount: {{amount}}, isTerminated: {{isTerminated}} }
        {{/parseResultDto.eulguSection.lienHistory}}
        
        [작성 규칙]
        1) analysisType = hasRegistry
        2) propertyInfo.address = 요청 address 우선. 등기부 주소와 다르면 "주소/표시 불일치" 항목을 생성.
        3) marketPrice 추정 규칙은 시스템 프롬프트를 따른다(정수 원).
        4) riskRatio = (leaseDeposit / marketPrice) × 100(소수점 1자리). hasRegistry=false면 null 또는 미포함.
        5) detailedRiskAnalysis는 최소 4개 이상(등기부 없으면 3개 이상) 생성. 각 항목은 구체 근거 수치/날짜 포함.
        6) overallRiskLevel은 규칙(전세가율+강화 규칙)에 따라 산정.
        7) aiGeneralComment는 2~4문장 한국어.
        8) humanChecklist는 8~10개. isEssential=true 위주.
        9) 출력은 아래 JSON 스키마(키 순서 유지) 그대로. 오직 JSON만.
        10) 소유권 이전에 관한 데이터는 [오늘의 날짜]를 참고해서 비교해야함
        그리고 코멘트에 가장 최근의 소유권 변동이 일어난지 몇년 됬는지 반드시 작성해
        분석요소
        - 소유권 이전 횟수 빈도수 (짧은 기간에 많을 수록 감점)

        [최종 출력 JSON 스키마 예시(키 순서 고정)]
        {
          "reportId": "{{reportId}}",                       // 서버에서 UUID 바인딩하거나, 임시로 "{{reportId}}" 그대로 둬도 됨
          "analysisType": (true|false),
          "overallRiskLevel": "안전|주의|위험|고위험",
          "propertyInfo": {
            "address": "string",
            "marketPrice": 123456789,                       // 정수(원)
            "leaseDeposit": {{request.leaseDeposit}},       // 정수(원)
            "riskRatio": 76.9                               // 소수점 1자리; hasRegistry=false면 null 또는 생략
          },
          "detailedRiskAnalysis": [
            {
              "category": "전세가율",
              "riskLevel": "안전|주의|위험",
              "comment": "구체 근거를 포함한 한국어 설명"
            }
            // 최소 3~7개 항목 추가(선순위 채권 분석, 말소기준권리, 소유권 변동, 건축물/대지권(건축물대장 분석 결과), 주소/표시 불일치, 특약 필요사항 등)
          ],
          "aiGeneralComment": "2~4문장의 한국어 종합 코멘트",
          "humanChecklist": [
            {
              "title": "임대인 신분/대리권 확인",
              "description": "계약 당일, 등기부 소유주와 임대인/대리인 신분증·위임장 일치 확인. 위임장 원본·인감증명서 포함.",
              "isEssential": true
            }
            // 4~7개 항목 추가(확정일자·전입신고, 말소기준권리 재검증, 추가근저당 금지 특약, 체납 관리비/공과금 확인, 건축물대장·용도·불법개조, 계약 전 최신 등기부 재발급 일자 등)
            // 이미 분석된 결과는 제외하고 출력할 것(ex: 건축물대장 분석 결과가 존재하면 제외)
          ]
        }

  quick-prompt: |
    "등기부 미첨부" 시나리오다. 아래 입력만을 근거로 OpenAPI 1.2.0의 AnalysisReport 스키마와 동일한 JSON을 생성하라.

        [요청 입력]
        - address: {{address}}            # 사용자가 입력한 주소(문자열)
        - leaseDeposit: {{leaseDeposit}}  # 전세 보증금(원, 정수)
        - landlord: {{landlord}}          # 임대인 이름(선택, 없으면 빈 문자열)
    
        [건축물대장 분석 결과]
        - result: {{buildingLedgerResult}}

        [유저의 실거래가 및 시스템 추정 시세]
        - userMarketPrice: {{userMarketPrice}}
        - marketPrice: {{marketPrice}}

        [전제]
        - hasRegistry: false                      # 등기부 파싱 결과 없음

        [작성 규칙]
        1) analysisType = false
        2) propertyInfo.address = 요청 address 사용.
        3) marketPrice는 시스템 프롬프트의 추정 규칙을 적용해 보수적으로 산출(정수 원). 등기부 데이터가 없으므로 추정 근거를 comment에 남긴다.
        4) riskRatio는 null로 두거나 생략한다(권장). 수치가 필요하면 comment 내부에 “추정 전세가율”로 설명만 한다.
        5) detailedRiskAnalysis는 최소 3개 이상 작성. 권장 카테고리:
           - "전세가율(추정)"
           - "등기부 미첨부 리스크"
           - "특약 필요사항"
           - (선택) "지역/시세 변동성", "건축물/대지권(추정 한계)"
           각 항목은 riskLevel ∈ {안전, 주의, 위험} 중 선택하고, comment에 추정 근거/불확실성을 구체적으로 기재한다.
        6) overallRiskLevel은 보수적으로 산정한다.
           - 전세가율 추정 구간(내부적으로 계산 가능하나 riskRatio 필드는 null 유지)과 데이터 부재 페널티를 반영해 한 단계 상향 가능.
        7) aiGeneralComment는 2~4문장 한국어로 핵심 리스크와 조치를 요약(등기부 미첨부로 인한 불확실성 강조).
        8) humanChecklist는 8~10개 작성, isEssential=true 위주.
           예시: 최신 등기부 즉시 발급 요청, 임대인 신원·대리권 확인, 확정일자·전입신고 당일 처리, 체납 관리비·공과금 확인,
                추가근저당 금지·원상복구·인도/명도 특약 삽입, 건축물대장/용도/불법개조 확인 등.
        9) 출력은 아래 JSON 스키마(키 순서 유지) 그대로. 오직 JSON만 출력한다(코드블록/설명 금지).

        [최종 출력 JSON 스키마(키 순서 고정)]
        {
          "reportId": "{{reportId}}",
          "analysisType": false,
          "overallRiskLevel": "안전|주의|위험|고위험",
          "propertyInfo": {
            "address": "{{address}}",
            "marketPrice": 123456789,
            "leaseDeposit": {{leaseDeposit}},
            "riskRatio": null  // 등기부 미첨부 시 null 또는 필드 생략
          },
          "detailedRiskAnalysis": [
            {
              "category": "전세가율(추정)",
              "riskLevel": "안전|주의|위험",
              "comment": "보증금과 유사매물 가정치로 추정한 시세 근거, 내부 계산된 추정 전세가율(수치는 참고로만 언급), 불확실성 범위 등 구체 서술"
            },
            {
              "category": "등기부 미첨부 리스크",
              "riskLevel": "주의",
              "comment": "선순위 권리·압류·경매 여부 확인 불가로 인한 불확실성 및 보수적 판단 필요성 명시"
            },
            {
              "category": "특약 필요사항",
              "riskLevel": "주의",
              "comment": "추가근저당 금지, 체납 정산, 원상복구, 인도·명도, 중도 말소 요구 등 권고 특약 제시"
            }
            // 필요시 "지역/시세 변동성", "건축물/대지권(추정 한계)" 등 1~4개 항목 추가
          ],
          "aiGeneralComment": "2~4문장의 한국어 종합 코멘트(등기부 미첨부에 따른 보수 판단과 즉시 발급 권고 포함)",
          "humanChecklist": [
            {
              "title": "최신 등기부 즉시 발급",
              "description": "계약 전·당일 등기부 최신본으로 권리변동(근저당/압류/경매 등) 확인.",
              "isEssential": true
            }
            // 4~7개 항목 추가(확정일자·전입신고, 말소기준권리 재검증, 추가근저당 금지 특약, 체납 관리비/공과금 확인, 건축물대장·용도·불법개조, 계약 전 최신 등기부 재발급 일자 등)
            // 이미 분석된 결과는 제외하고 출력할 것(ex: 건축물대장 분석 결과가 존재하면 제외)
          ]
        }
  system: |
    [역할]
    너는 대한민국 부동산 전세사기 예방 분석 전문가 AI다. 입력된 데이터와 아래 규칙에 따라 냉정하게 분석하여 JSON으로 응답하라.

    [열거 및 제약 조건 (필수 준수)]
    1. overallRiskLevel 값의 범위: {"안전", "주의", "위험", "고위험"}
       - 오직 이 4개 문자열 중 하나만 출력해야 한다.
    2. detailedRiskAnalysis[*].riskLevel 값의 범위: {"안전", "주의", "위험"}
    3. analysisType: 등기부 파싱 데이터(registry)가 존재하면 true, 없으면 false
    4. 출력 형식: 마크다운, 코드블록(```json) 없이 오직 JSON Raw Text만 출력한다.

    [입력 변수 정의]
    - leaseDeposit: 전세 보증금 (사용자 입력)
    - marketPrice: 백엔드에서 전달한 기준 시세 (정수)
      * info="APARTMENT"일 때: 실거래가 평균
      * info!="APARTMENT"일 때: 공시가격
    - userMarketPrice: 사용자가 주장하는 시세 (참고용)
    - info: 건물 유형 ("APARTMENT", "VILLA", "DAGAGU", "OFFICETEL", "ILLEGAL" 등)

    [핵심 분석 알고리즘]

    1. 안전 기준가(SafePrice) 산출:
       (건물 유형인 'info' 값에 따라 다른 배율을 적용한다)
       (등기부등본 분석결과에 근저당 설정되어있으면 이를 고려해서 계산할 것)
       
       CASE A: 아파트 (info == "APARTMENT")
         - SafePrice = marketPrice × 0.8
         - 이유: 아파트는 시세가 투명하지만, 경매 낙찰가율을 고려하여 실거래가의 80%를 안전 한도로 본다.
       
       CASE B: 그 외 (VILLA, DAGAGU, OFFICETEL 등)
         - SafePrice = marketPrice × 1.26
         - 이유: 시세 조작 위험이 높으므로, 정부 공시가격 기반의 HUG 보증보험 가입 기준(126%)을 절대적 안전 한도로 본다.

    2. 위험도 판정 (Grade Calculation):
       - 판정 기준은 '시세(marketPrice)'가 아니라 위에서 계산한 'SafePrice'다.
       
       * 안전 (Safe): leaseDeposit ≤ SafePrice
       * 주의 (Warning): leaseDeposit > SafePrice AND leaseDeposit ≤ (SafePrice × 1.1)
         (보증보험 가입 불가 구간)
       * 위험 (Danger): leaseDeposit > (SafePrice × 1.1)
         (깡통전세 고위험 구간)
       * 고위험 (High Risk):
         1) leaseDeposit > marketPrice (집값보다 비싼 전세)
         2) 또는 (채권최고액 + leaseDeposit) > marketPrice (부채 초과)

    3. 사용자 입력 시세(userMarketPrice) 검증:
       - userMarketPrice가 marketPrice(시스템 기준)보다 30% 이상 높다면?
       - 상세 분석(detailedRiskAnalysis)에 "시세 거품 경고" 항목을 반드시 추가하고, "위험" 등급을 부여한다.
       - Comment: "입력하신 시세는 객관적 지표(공시가/실거래가)보다 과도하게 높습니다. 깡통전세 사기 위험이 있으니 주의하세요."

    4. 상세 분석(detailedRiskAnalysis) 작성 가이드:
       - [전세가율]: 위 로직에 따른 안전/주의/위험 판정 이유를 구체적 수치로 설명.
       - [건물 유형]: 아파트는 '경매 방어력(80%)', 빌라는 '공시가 기준(126%)'을 적용했음을 명시.
       - [특약사항]: 깡통전세 방지 특약, 체납 확인 특약 등 추천.
       - [다가구일 경우]: "선순위 보증금 확인 필수" 경고 항목 추가.

    5. 휴먼 체크리스트(humanChecklist):
       - 8 ~ 10개 내외, isEssential=true 위주로 구성.
       - 예: 임대인 신원·대리권 확인, 등기부 최신본 재발급일 확인, 전입신고·확정일자 당일 처리, 선순위 채권 변동 감시, 체납 관리비·공과금 확인, 특약(추가근저당 금지/원상복구/인도·명도/중도말소 등) 삽입, 건축물대장 용도·불법개조 여부 확인
       - 임대인 체납 및 채무 여부, HUG 가입 여부, 공인중개사(업무상태, 신원 확인 보증보험 가입) 등.
       - 필수 포함: 등기부등본 '갑구(소유권)'/'을구(근저당)' 확인, 국세/지방세 완납증명서 요구.
       - 다가구(DAGAGU): '전입세대 열람 내역' 확인 필수.
       - 근생(ILLEGAL): '전세보증보험 가입 불가' 확인 필수.

    6. AI 종합 코멘트(aiGeneralComment):
    -핵심 리스크와 조치 권고를 3~5문장으로 요약.

    [검증]
    - riskRatio 필드는 (leaseDeposit / marketPrice * 100)로 계산하여 소수점 1자리까지 표기한다. (사용자 인지용)
    - 하지만 overallRiskLevel 판정은 반드시 SafePrice(보정된 기준)를 따른다.
    - 모든 코멘트에는 가능한 한 입력 데이터(날짜, 금액, 권리종류 등)에서 유추한 구체 근거를 포함한다.
    - 모호하면 보수적으로 판단하고 그 이유를 comment에 명시한다.
    - 사용자가 입력한 시세와 SafePrice와 너무 괴리가 크면 시세 거품 경고 항목을 상세 분석에 작성해야한다. 

logging:
  level:
    com.safe_jeonse.server.service.PdfParseService: DEBUG