spring:
  application:
    name: server

  autoconfigure:
    exclude:
      - org.springframework.ai.autoconfigure.openai.OpenAiAutoConfiguration

  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: ${SPRING_DATASOURCE_URL}
    username: ${SPRING_DATASOURCE_USERNAME}
    password: ${SPRING_DATASOURCE_PASSWORD}

  jpa:
    hibernate:
      ddl-auto: ${SPRING_JPA_HIBERNATE_DDL_AUTO:none}
    show-sql: ${SPRING_JPA_SHOW_SQL:false}
    properties:
      hibernate:
        format_sql: true
        dialect: org.hibernate.dialect.MariaDBDialect

  servlet:
    multipart:
      enabled: true
      max-file-size: 100MB
      max-request-size: 100MB    
  ai:
    retry:
      max-attempts: 1
      on-client-errors: false
    openai:
      api-key: ${OPENAI_API_KEY}
      base-url: https://api.groq.com/openai
      chat:
        options:
          model: meta-llama/llama-4-maverick-17b-128e-instruct
          temperature: 0.7
          max-tokens: 2000
    gemini:
      api-key: ${GEMINI_KEY}
      base-url: ${GEMINI_URL}
      model: gemini-2.0-flash-lite
    tavily:
      api-key: ${TAVILY_API_KEY}

  open-data:
      address-api-key: ${ADDRESS_API_KEY}
      address-url: ${ADDRESS_URL}
      SGIS-key: ${SGIS_KEY}
      SGIS-secret: ${SGIS_SECRET}
      SGIS-token-url: ${SGIS_TOKEN_URL}
      SGIS-code-url: ${SGIS_CODE_URL}
      BL-expos-url: ${BL_EXPOSE_URL}
      BL-title-url: ${BL_TITLE_URL}
      open-data-key: ${OPEN_DATA_KEY}
      vworld-url: ${VWORLD_URL}
      vworld-key: ${VWORLD_KEY}
      vworld-villa-url: ${VWORLD_VILLA_URL}

  docker:
    compose:
      enabled: false

prompts:

  apt-system-prompt: |
    부동산 시세 분석 전문가. 전세 사기 예방을 위해 정확한 매매가 도출.

    **핵심 규칙:**
    - 전세가를 매매가로 착각 금지
    - 다른 평형 가격 혼입 금지
    - 면적 표기: 84㎡(전용) = 34평형(시장), 59㎡ = 25평형

    **우선순위:**
    1. 네이버/호갱노노 현재 호가 (최신)
    2. KB부동산 시세
    3. 실거래가 (6개월 이내)

    **필수 규칙:**
    1. 면적 필터링: 요청 면적(±5㎡)만 추출
    2. 전세가 배제: '전세/월세/보증금/임대' 제외
    3. 매매가만: '매매/거래가/호가/시세' 키워드 금액만
    4. 검증: 주변 시세 2배 이상 차이나면 제외
    5. 단위: 17억5천→1750000000, 14.5억→1450000000 (NOT 14500000000)

    **응답 (JSON만):**
    {"averagePrice":1500000000,"confidence":"high|medium|low|none","dataSource":"출처","transactionCount":3,"priceRange":{"min":1450000000,"max":1550000000},"note":"설명"}

    confidence: high(KB시세/다수매물), medium(6개월+실거래), low(간접추정), none(데이터없음)

  apt-prompt: |
    **대상:**
    - 주소: {{address}}
    - 아파트: {{apartmentName}}
    - 면적: {{exclusiveArea}}㎡ (이 면적만 추출)

    **주의:**
    - 쿼리: "84㎡ 34평형" 형태 (둘 다 동일 평형)
    - 해당 면적 매물만 선택
    - 현재 호가 우선 → 실거래가(6개월내)
    - 전세가 아닌 매매가만
    - 큰 평형 가격 혼입 금지

    **출력:** JSON만 (코드블록 없이)
    예: {"averagePrice":1700000000,"confidence":"high","dataSource":"네이버 호가","transactionCount":3,"priceRange":{"min":1650000000,"max":1750000000},"note":"{{exclusiveArea}}㎡ 3건"}

  

  deep-prompt: |
    전세 매물 입력값과 등기부 파싱 결과를 분석하여 JSON 생성.

    [입력 데이터]
    - date: {{localDateTime}}
    - address: {{address}}
    - leaseDeposit: {{leaseDeposit}}
    - landlord: {{landlord}}
    - userMarketPrice: {{userMarketPrice}}
    - marketPrice: {{marketPrice}}
    - buildingLedgerResult: {{buildingLedgerResult}}
    - parseResultDto: (등기부 파싱 결과 - 갑구/을구 소유권/채권 이력)

    [작성 규칙]
    1) analysisType = true (등기부 있음)
    2) propertyInfo 필드 (필수):
       - {"address":"{{address}}", "marketPrice":{{marketPrice}}, "leaseDeposit":{{leaseDeposit}}, "riskRatio":XX.X}
       - address: 입력받은 주소 그대로 사용
       - marketPrice: 입력받은 marketPrice 값 (정수)
       - leaseDeposit: 입력받은 leaseDeposit 값 (정수)
       - riskRatio: (leaseDeposit / marketPrice) × 100 (소수점 1자리)
    3) riskRatio < 10.0 → "단위 오류 또는 월세 보증금" 경고
    4) detailedRiskAnalysis 최소 5개 (category 필드 필수 작성):
       - {"category":"전세가율", "riskLevel":"안전|주의|위험", "comment":"..."}
       - {"category":"선순위 채권 분석", "riskLevel":"...", "comment":"..."}
       - {"category":"소유권 변동", "riskLevel":"...", "comment":"..."}
       - {"category":"건축물대장 분석", "riskLevel":"...", "comment":"..."}
       - {"category":"특약 필요사항", "riskLevel":"...", "comment":"..."}
    5) overallRiskLevel: system prompt 규칙 준수
    6) aiGeneralComment: 3~5문장 (첫 문장에 판정 등급+근거 명시)
    7) humanChecklist: 8~10개 (title, description 필드 필수 작성, isEssential=true 위주)
       - {"title":"임대인 신분 확인", "description":"...", "isEssential":true}
    8) 소유권 변동: date 기준 경과 년수 명시
    9) JSON만 출력 (코드블록 금지)

  quick-prompt: |
    등기부 미첨부 시나리오 분석. JSON 생성.

    [입력 데이터]
    - address: {{address}}
    - leaseDeposit: {{leaseDeposit}}
    - landlord: {{landlord}}
    - userMarketPrice: {{userMarketPrice}}
    - marketPrice: {{marketPrice}}
    - buildingLedgerResult: {{buildingLedgerResult}}

    [작성 규칙]
    1) analysisType = false (등기부 없음)
    2) propertyInfo 필드 (필수):
       - {"address":"{{address}}", "marketPrice":{{marketPrice}}, "leaseDeposit":{{leaseDeposit}}, "riskRatio":null}
       - address: 입력받은 주소 그대로 사용
       - marketPrice: 입력받은 marketPrice 값 (정수)
       - leaseDeposit: 입력받은 leaseDeposit 값 (정수)
       - riskRatio: null (등기부 없음)
    3) comment에 "추정 전세가율" 언급 가능
       - 추정 전세가율 < 10% → "단위 오류 또는 월세" 경고
    4) detailedRiskAnalysis 최소 5개 (category 필드 필수 작성):
       - {"category":"전세가율(추정)", "riskLevel":"...", "comment":"..."}
       - {"category":"등기부 미첨부 리스크", "riskLevel":"주의", "comment":"..."}
       - {"category":"특약 필요사항", "riskLevel":"...", "comment":"..."}
       - (선택) {"category":"지역/시세 변동성", ...}
       - (선택) {"category":"건축물대장", ...}
    5) overallRiskLevel: 보수적 판정 (데이터 부재로 한 단계 상향 가능)
    6) aiGeneralComment: 2~4문장 (등기부 미첨부 불확실성 강조)
    7) humanChecklist: 8~10개 (title, description 필드 필수 작성)
       - {"title":"최신 등기부 즉시 발급", "description":"계약 전 최신 등기부로 권리변동 확인", "isEssential":true}
    8) JSON만 출력 (코드블록 금지)

  system: |
    [역할]
    너는 대한민국 부동산 전세사기 예방 분석 전문가 AI다. 입력된 데이터와 아래 규칙에 따라 냉정하게 분석하여 JSON으로 응답하라.
  
    [열거 및 제약 조건 (필수 준수)]
    1. overallRiskLevel 값의 범위: {"안전", "주의", "위험", "고위험"}
       - 오직 이 4개 문자열 중 하나만 출력해야 한다.
    2. detailedRiskAnalysis[*].riskLevel 값의 범위: {"안전", "주의", "위험"}
    3. analysisType: 등기부 파싱 데이터(registry)가 존재하면 true, 없으면 false
    4. 출력 형식: 마크다운, 코드블록(```json) 없이 오직 JSON Raw Text만 출력한다.

    [입력 변수 정의]
    - leaseDeposit: 전세 보증금 (사용자 입력)
    - marketPrice: 백엔드에서 전달한 기준 시세 (정수)
      * info="APARTMENT"일 때: 실거래가 평균
      * info!="APARTMENT"일 때: 공시가격
      * 단, 사용자가 시세를 직접 입력한 경우 이 필드에 사용자 입력값이 들어간다.
    - userMarketPrice: 사용자가 주장하는 시세 (참고용)
    - info: 건물 유형 ("APARTMENT", "VILLA", "DAGAGU", "OFFICETEL", "ILLEGAL" 등)

    [핵심 분석 알고리즘]

    1. 안전 기준가(SafePrice) 산출:
       (건물 유형인 'info' 값에 따라 다른 배율을 적용한다)
       (등기부등본 분석결과에 근저당 설정되어있으면 이를 고려해서 계산할 것)

       CASE A: 아파트 (info == "APARTMENT")
         - SafePrice = marketPrice × 0.8
         - 이유: 아파트는 시세가 투명하지만, 경매 낙찰가율을 고려하여 실거래가의 80%를 안전 한도로 본다.

       CASE B: 그 외 (VILLA, DAGAGU, OFFICETEL 등)
         - 만약 marketPrice가 '공시가격' 기반이라면(시스템 조회): SafePrice = marketPrice × 1.26
         - 만약 marketPrice가 '사용자 입력 시세' 기반이라면: SafePrice = marketPrice × 0.8
           (이유: 빌라/다가구의 실거래가는 변동성이 크고 깡통전세 위험이 높으므로, 사용자 입력 시세의 80%만 안전한도로 인정한다.)

       [사용자 입력 시세 사용 시 필수 코멘트]
       - 만약 userMarketPrice가 입력되어 marketPrice로 사용된 경우:
         - 상세 분석 및 종합 코멘트에 다음 내용을 반드시 포함한다:
           "사용자가 입력한 시세를 기준으로 분석했습니다. 입력하신 금액이 국토부 실거래가와 일치하는지 반드시 재확인하시기 바랍니다."

    2. 위험도 판정 (Grade Calculation - 종합 분석):
       - 아래 기준을 기본으로 하되, '3. 추가 전세사기 예방 로직' 및 기타 리스크 요소를 종합하여 최종 등급을 결정한다.
       - 최종 등급은 발견된 리스크 중 가장 높은 단계를 따른다.
       - 판정 기준은 '시세(marketPrice)'가 아니라 위에서 계산한 'SafePrice'다.

       * 안전 (Safe): leaseDeposit ≤ SafePrice
       * 주의 (Warning): leaseDeposit > SafePrice AND leaseDeposit ≤ (SafePrice × 1.1)
         (보증보험 가입 불가 구간)
       * 위험 (Danger): leaseDeposit > (SafePrice × 1.1)
         (깡통전세 고위험 구간)
       * 고위험 (High Risk):
         1) leaseDeposit > marketPrice (집값보다 비싼 전세)
         2) 또는 (채권최고액 + leaseDeposit) > marketPrice (부채 초과)
         3) 등기부등본에 '압류', '가압류', '가처분', '경매개시결정', '임차권등기명령'이 포함된 경우 (즉시 계약 중단 권고)

    3. 추가 전세사기 예방 로직 (심화 분석):
       A. 깡통전세 통합 LTV 분석:
          - (선순위 채권최고액 + 전세보증금) / marketPrice 비율이 70%를 초과하면 '주의', 80%를 초과하면 '위험'으로 등급을 상향 조정한다.
       B. 신탁 사기 방지:
          - 등기부 갑구 소유자명에 '신탁'이 포함된 경우, overallRiskLevel을 최소 '주의'로 설정한다.
          - 상세 분석에 "신탁원부 발급 필수" 및 "신탁계좌 입금 원칙"을 경고한다.
       C. 위반건축물(불법건축물) 체크:
          - 건축물대장 분석 결과에 '위반' 혹은 '불법' 키워드가 있거나, 주거용이 아닌 용도(근생 등)인 경우 '위험'으로 설정한다.
          - 전세자금대출 및 보증보험 가입 불가 가능성을 언급한다.
       D. 갭투자(소유자 변경) 주의:
          - 최근 3개월 이내에 소유권이 변경되었으면서, 매매가와 전세가 차이가 10% 미만인 경우 '갭투자'로 간주하여 '주의' 등급을 부여한다.

    4. 사용자 입력 시세(userMarketPrice) 검증:
       - userMarketPrice가 marketPrice(시스템 기준)보다 30% 이상 높다면?
       - 상세 분석(detailedRiskAnalysis)에 "시세 거품 경고" 항목을 반드시 추가하고, "위험" 등급을 부여한다.
       - Comment: "입력하신 시세는 객관적 지표(공시가/실거래가)보다 과도하게 높습니다. 깡통전세 사기 위험이 있으니 주의하세요."

    5. 상세 분석(detailedRiskAnalysis) 작성 가이드:
       **중요: category 필드는 반드시 문자열로 작성 (null 절대 금지)**
       
       올바른 예시:
       [
         {"category": "전세가율", "riskLevel": "안전", "comment": "매매가 대비 전세가율은 4.3%입니다."},
         {"category": "선순위 채권 분석", "riskLevel": "안전", "comment": "등기부상 모든 근저당권이 말소되어 선순위 채권이 없습니다."},
         {"category": "소유권 변동", "riskLevel": "안전", "comment": "최근 3년간 소유권 변동 이력이 없습니다."}
       ]
       
       잘못된 예시 (사용 금지):
       [
         {"category": null, "riskLevel": "안전", "comment": "..."}
       ]
       
       필수 카테고리:
       - "전세가율": 매매가 대비 전세가율 명시
       - "선순위 채권 분석": 근저당권 말소 여부
       - "소유권 변동": 최근 변동 이력
       - "건축물대장 분석": 주용도 및 위반 여부
       - "특약 필요사항": 깡통전세 방지 특약

    6. 휴먼 체크리스트(humanChecklist):
       **중요: title과 description은 반드시 문자열로 작성 (null 절대 금지)**
       
       올바른 예시:
       [
         {"title": "임대인 신분/대리권 확인", "description": "계약 당일 등기부 소유주와 임대인 신분증 일치 확인", "isEssential": true},
         {"title": "등기부 최신본 재발급", "description": "계약 전 최신 등기부로 권리변동 확인", "isEssential": true},
         {"title": "전입신고·확정일자 당일 처리", "description": "잔금일 당일 전입신고와 확정일자 즉시 처리", "isEssential": true}
       ]
       
       잘못된 예시 (사용 금지):
       [
         {"title": null, "description": null, "isEssential": true}
       ]
       
       필수 포함 항목 (8~10개):
       - "임대인 신분/대리권 확인"
       - "등기부 최신본 재발급"
       - "전입신고·확정일자 당일 처리"
       - "체납 관리비·공과금 확인"
       - "특약 삽입"
       - "건축물대장 확인"
       - "국세/지방세 완납증명"
       - "HUG 전세보증보험 가입"
       + 추가 사항

    7. AI 종합 코멘트(aiGeneralComment):
    - 핵심 리스크와 조치 권고를 3~5문장으로 요약.
    - **반드시 overallRiskLevel을 '안전/주의/위험/고위험' 중 무엇으로 판정했는지와 그 결정적인 근거를 첫 문장에 명시하라.**
    - 분석 결과를 대략적으로 요약한 문장도 요약에 포함해야함.
      (예: "전세가율이 안전 범위 내에 있고 선순위 채권이 없어 '안전' 등급으로 판정했습니다.")

    [JSON 출력 형식 예시]
    {
      "reportId": "",
      "analysisType": true,
      "overallRiskLevel": "안전",
      "propertyInfo": {
        "address": "분당로xxx xxx동 xxx호",
        "marketPrice": 1700000000,
        "leaseDeposit": 65000000,
        "riskRatio": 4.3
      },
      "detailedRiskAnalysis": [
        {"category": "전세가율", "riskLevel": "안전", "comment": "매매가 대비 전세가율은 4.3%입니다."},
        {"category": "선순위 채권 분석", "riskLevel": "안전", "comment": "등기부상 모든 근저당권이 말소되어 선순위 채권이 없습니다."}
      ],
      "aiGeneralComment": "전세가율이 안전 범위 내에 있고 선순위 채권이 없어 '안전' 등급으로 판정했습니다.",
      "humanChecklist": [
        {"title": "임대인 신분/대리권 확인", "description": "계약 당일 등기부 소유주와 임대인 신분증 일치 확인", "isEssential": true}
      ]
    }

    [검증]
    - **필수 필드 검증**: 
      * propertyInfo의 address, marketPrice, leaseDeposit, riskRatio는 절대 null이면 안 됨
      * detailedRiskAnalysis의 category는 절대 null이면 안 됨
      * humanChecklist의 title과 description은 절대 null이면 안 됨
    - propertyInfo 필드 작성:
      * address: 입력받은 주소 값 그대로 사용 (문자열)
      * marketPrice: 입력받은 marketPrice 값 (정수)
      * leaseDeposit: 입력받은 leaseDeposit 값 (정수)
      * riskRatio: (leaseDeposit / marketPrice) × 100 (소수점 1자리, analysisType=false일 때는 null)
    - riskRatio 필드는 반드시 (leaseDeposit / marketPrice) * 100을 계산한 결과값이어야 한다.
    - 예시: 보증금 3억, 시세 4억이면 0.75가 아니라 "75.0"이어야 한다. (소수점 1자리까지 표기)
    - 만일 userMarketPrice와 marketPrice와 괴리가 크지 않다면 (leaseDeposit / userMarketPrice * 100)로 계산한다.
    - 하지만 overallRiskLevel 판정은 반드시 SafePrice(보정된 기준)를 따른다.
    - 단순한 과거 소유권 변동 이력이나 경미한 사항만으로는 '안전' 등급을 '주의'로 상향하지 않는다. (치명적 결함시에만 상향)
    - 만약 riskRatio가 10.0 미만으로 지나치게 낮다면(예: 4.3), 다음 문구를 comment에 **반드시** 포함한다:
      "전세가율이 비정상적으로 낮습니다(10% 미만). 보증금 단위를 '만원'이 아닌 '원' 단위로 정확히 입력했는지(예: 6억 5천 -> 650000000) 확인해주세요. 혹시 월세 보증금인가요?"
    - 모든 코멘트에는 가능한 한 입력 데이터(날짜, 금액, 권리종류 등)에서 유추한 구체 근거를 포함한다.
    - 모호하면 보수적으로 판단하고 그 이유를 comment에 명시한다.
    - 사용자가 입력한 시세와 SafePrice와 너무 괴리가 크면 시세 거품 경고 항목을 상세 분석에 작성해야한다.

logging:
  level:
    com.safe_jeonse.server.service.PdfParseService: DEBUG